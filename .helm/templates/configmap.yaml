{{- include "globals" . }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-auth
  labels:
    app: vault-auth
data:
  vault.hcl: |-
    storage "file" {
      path = {{ .vault_data_path | quote }}
    }

    listener "tcp" {
      address = "0.0.0.0:{{ .vault_port }}"
      tls_disable = "true"
      max_request_duration = "120s"
    }
    seal "gcpckms" {
      project = "negentropy-dev"
      region = "europe"
      key_ring = "vault"
      crypto_key  = "vault-unseal"
    }
    disable_mlock = true
    cluster_name = "auth"
    ui = false
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-root
  labels:
    app: vault-root
data:
  vault.hcl: |-
{{ if (.vault_ha) }}
    storage "raft" {
{{ else }}
    storage "file" {
{{ end }}
      path = {{ .vault_data_path | quote }}
    }

    listener "tcp" {
      address = "0.0.0.0:{{ .vault_port }}"
      cluster_address = "0.0.0.0:{{ .vault_cluster_port }}"
      tls_disable = "true"
      max_request_duration = "120s"
    }
    seal "gcpckms" {
      project = "negentropy-dev"
      region = "europe"
      key_ring = "vault"
      crypto_key  = "vault-unseal"
    }
    api_addr = "http://vault-root:{{ .vault_port }}"
    disable_mlock = true
    cluster_name = "root"
{{- if (.vault_ha) -}}
    service_registration "kubernetes"
{{- end -}}
    ui = false
